include:
  - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.ci-ext.yml'

stages:
  - build

build uenv:
  extends: ['.f7t-runner', '.f7t-uenv-builder']
  tags: [f7t-runner-tds] # TODO: remove this tag, that should not run on the TDS runner
  stage: build
  variables:
    STACK_RECIPE: recipe
    STACK_SYSTEM: $system
    STACK_TAG: $CI_PIPELINE_ID
    STACK_NAME: $name/$version
    STACK_UARCH: $uarch
    STACK_REPO_DIR: $CSCS_REGISTRY_PATH/public/$system/$uarch
    F7T_URL: 'https://invalid-url'
    UENV_LOCAL: 'NO'
    SLURM_TIMELIMIT: '04:00:00'
  rules:
    - if: $system == "daint"
      variables:
        F7T_URL: "https://api.cscs.ch/hpc/firecrest/v1"
        FIRECREST_SYSTEM: daint
        ARCH: 'aarch64'
    - if: $system == "todi"
      variables:
        F7T_URL: "https://api.cscs.ch/cscs/firecrest/v1"
        FIRECREST_SYSTEM: todi
        ARCH: 'aarch64'
    - if: $system == "eiger"
      variables:
        F7T_URL: 'https://firecrest.cscs.ch'
        FIRECREST_SYSTEM: eiger
        SLURM_CONSTRAINT: mc
        ARCH: 'x86_64'
    - if: $system == "balfrin"
      variables:
        F7T_URL: 'https://api.cscs.ch/mch/firecrest/v1'
        FIRECREST_SYSTEM: balfrin
        ARCH: 'x86_64'
